<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FOUNDRY V5 // ENTERPRISE ONTOLOGY</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-dagre/2.5.0/cytoscape-dagre.min.js"></script>

    <style>
        :root {
            --bg: #030304;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --neon-blue: #00f3ff;
            --neon-pink: #bc13fe;
            --neon-green: #0aff0a;
            --text: #ffffff;
        }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text); }

        /* --- 1. VIEWPORT & CONTAINERS --- */
        #viewport { position: relative; width: 100vw; height: 100vh; perspective: 1000px; overflow: hidden; }
        
        #cy-container { 
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; 
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #globe-container { 
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; 
            opacity: 0; pointer-events: none; transition: opacity 0.5s; 
        }

        /* --- 2. ISO-CONDO MODE (THE MAGIC) --- */
        /* พื้นหลังคอนโด (Platforms) จะถูกสร้างด้วย JS */
        .iso-platform {
            position: absolute; left: 50%; transform: translateX(-50%) rotateX(60deg) rotateZ(-45deg);
            width: 800px; height: 800px;
            background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.05));
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.05), inset 0 0 20px rgba(0,0,0,0.5);
            pointer-events: none; z-index: 1; opacity: 0; transition: opacity 0.5s, top 0.8s;
            display: flex; align-items: flex-end; justify-content: flex-end;
            padding: 20px; font-size: 20px; font-weight: bold; color: rgba(255,255,255,0.2); text-transform: uppercase;
        }

        /* เอฟเฟกต์ตอนกดปุ่ม Layers */
        .mode-iso #cy-container {
            /* เอียงกราฟให้เข้ากับฐาน */
            transform: scale(0.8) rotateX(0deg); /* Cytoscape 2D แต่เราจะจัดตำแหน่ง Node ให้เหมือน 3D */
        }

        /* --- 3. UI TOOLBAR (COMPACT) --- */
        .toolbar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px);
            border: 1px solid var(--border); border-radius: 50px;
            padding: 8px 15px; display: flex; gap: 8px; z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .btn {
            background: transparent; border: none; color: #888; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: 0.2s; position: relative;
        }
        .btn:hover { background: rgba(255,255,255,0.1); color: #fff; transform: translateY(-2px); }
        .btn.active { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        
        /* Tooltip */
        .btn::after {
            content: attr(data-tooltip); position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff; font-size: 10px; padding: 4px 8px; border-radius: 4px;
            opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap;
        }
        .btn:hover::after { opacity: 1; bottom: -35px; }

        /* --- 4. SIDEBAR --- */
        #sidebar {
            position: absolute; right: 20px; top: 80px; width: 300px;
            background: rgba(10, 15, 20, 0.95); border-left: 2px solid var(--neon-blue);
            backdrop-filter: blur(15px); padding: 20px; border-radius: 0 0 0 20px;
            transform: translateX(350px); transition: 0.3s; z-index: 100;
        }
        #sidebar.active { transform: translateX(0); }
        
        /* Node Styles in Sidebar */
        .kpi-box {
            background: rgba(255,255,255,0.05); padding: 15px; margin-top: 15px; border-radius: 8px;
            display: flex; justify-content: space-between;
        }
        
        #file-input { display: none; }
        
        /* Loading Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999;
            display: flex; justify-content: center; align-items: center; color: var(--neon-blue); font-family: monospace;
            transition: opacity 0.5s;
        }

    </style>
</head>
<body class="mode-net">

    <div id="loader">INITIALIZING FOUNDRY CORE...</div>

    <div id="plat-3" class="iso-platform" style="top: 150px;">Customers & Logistics</div>
    <div id="plat-2" class="iso-platform" style="top: 350px;">Manufacturing Hub</div>
    <div id="plat-1" class="iso-platform" style="top: 550px;">Global Suppliers</div>

    <div class="toolbar">
        <div style="margin-right:10px; font-weight:bold; color:#fff; display:flex; align-items:center;">
            <i class="fas fa-cube" style="color:var(--neon-blue); margin-right:8px;"></i> V5
        </div>
        
        <button class="btn active" onclick="setMode('network')" data-tooltip="Clean Network"><i class="fas fa-sitemap"></i></button>
        <button class="btn" onclick="setMode('globe')" data-tooltip="World Map"><i class="fas fa-globe-americas"></i></button>
        <button class="btn" onclick="setMode('iso')" data-tooltip="Condo Layers"><i class="fas fa-layer-group"></i></button>
        
        <div style="width:1px; background:#444; margin:0 5px;"></div>
        
        <label for="file-input" class="btn" data-tooltip="Import Excel"><i class="fas fa-file-upload"></i></label>
        <input type="file" id="file-input" accept=".xlsx, .xls">
        <button class="btn" onclick="loadDemo()" data-tooltip="Reset Demo"><i class="fas fa-sync-alt"></i></button>
    </div>

    <div id="viewport">
        <div id="cy-container"></div>
        <div id="globe-container"></div>
    </div>

    <div id="sidebar">
        <h2 id="sb-title" style="margin:0; font-size:18px; color:var(--neon-blue);">OBJECT</h2>
        <div id="sb-type" style="font-size:11px; color:#888; text-transform:uppercase; margin-bottom:15px;">TYPE</div>
        <div style="height:1px; background:#333; margin-bottom:15px;"></div>
        <div id="sb-content" style="font-size:13px; color:#ccc; line-height:1.6;">Select an object...</div>
        <div class="kpi-box">
            <div>
                <div style="font-size:10px; color:#aaa;">STATUS</div>
                <div style="color:#0aff0a;">ONLINE</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:10px; color:#aaa;">LATENCY</div>
                <div>12ms</div>
            </div>
        </div>
    </div>

    <script>
        // --- 0. SETUP ---
        const Colors = { supplier: '#ff3366', factory: '#00f3ff', customer: '#bc13fe', default: '#ffffff' };
        let cy, globe;
        let appData = { nodes: [], edges: [] };
        
        // Hide Loader
        setTimeout(() => {
            document.getElementById('loader').style.opacity = 0;
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
        }, 1500);

        // --- 1. CYTOSCAPE (2D & ISO) ---
        function initCy() {
            cy = cytoscape({
                container: document.getElementById('cy-container'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)', 'color': '#fff', 'font-size': '10px', 'font-weight': 'bold',
                            'text-valign': 'bottom', 'text-margin-y': 5,
                            'background-color': '#111', 'border-width': 2, 'border-color': ele => Colors[ele.data('type')] || '#888',
                            'width': 40, 'height': 40
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 1.5, 'line-color': '#444', 'target-arrow-color': '#444', 
                            'target-arrow-shape': 'triangle', 'curve-style': 'bezier'
                        }
                    },
                    // STYLE สำหรับ ISO-CONDO MODE (ทำให้ดูเป็นตึก)
                    {
                        selector: '.iso-block',
                        style: {
                            'shape': 'round-rectangle', 'width': 60, 'height': 40,
                            'background-opacity': 0.8, 'background-color': '#000',
                            'border-width': 1, 'border-color': ele => Colors[ele.data('type')] || '#fff',
                            'shadow-blur': 0, 'shadow-offset-y': 5, 'shadow-color': ele => Colors[ele.data('type')] || '#fff', // Fake 3D depth
                            'text-valign': 'center', 'text-halign': 'center', 'font-size': '8px'
                        }
                    }
                ]
            });

            cy.on('tap', 'node', evt => openSidebar(evt.target.data()));
            cy.on('tap', evt => { if(evt.target === cy) document.getElementById('sidebar').classList.remove('active'); });
        }

        // --- 2. MODES LOGIC ---
        function setMode(mode) {
            // Update UI
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active'); // Highlight button
            document.body.className = `mode-${mode}`;

            // Reset Views
            const cyDiv = document.getElementById('cy-container');
            const globeDiv = document.getElementById('globe-container');
            const platforms = document.querySelectorAll('.iso-platform');

            // 1. GLOBE MODE
            if (mode === 'globe') {
                cyDiv.style.opacity = 0; cyDiv.style.pointerEvents = 'none';
                globeDiv.style.opacity = 1; globeDiv.style.pointerEvents = 'auto';
                platforms.forEach(p => p.style.opacity = 0);
                initGlobe();
            } 
            // 2. ISO-CONDO MODE
            else if (mode === 'iso') {
                cyDiv.style.opacity = 1; cyDiv.style.pointerEvents = 'auto';
                globeDiv.style.opacity = 0; globeDiv.style.pointerEvents = 'none';
                
                // Show Platforms
                platforms.forEach(p => p.style.opacity = 1);
                
                // Change Node Style to Blocks
                cy.elements().addClass('iso-block');

                // *** สูตรคำนวณตำแหน่ง CONDO ***
                cy.batch(() => {
                    const layers = { supplier: 550, factory: 350, customer: 150 }; // Y positions matching DOM divs
                    const groupings = { supplier: [], factory: [], customer: [] };

                    // Group nodes
                    cy.nodes().forEach(n => {
                        let t = n.data('type');
                        if(!groupings[t]) t = 'factory'; // fallback
                        groupings[t].push(n);
                    });

                    // Arrange nodes on each platform
                    Object.keys(groupings).forEach(type => {
                        const nodes = groupings[type];
                        const count = nodes.length;
                        const rowSize = Math.ceil(Math.sqrt(count));
                        const baseY = layers[type];

                        nodes.forEach((n, idx) => {
                            const r = Math.floor(idx / rowSize);
                            const c = idx % rowSize;
                            // Isometric Grid Calculation
                            const isoX = (c - r) * 60 + (window.innerWidth/2);
                            const isoY = (c + r) * 30 + baseY - 100; // Offset to fit platform
                            
                            n.position({ x: isoX, y: isoY });
                        });
                    });
                });
                
                cy.fit();
                cy.zoom(1.2);
            } 
            // 3. NETWORK MODE (Standard)
            else {
                cyDiv.style.opacity = 1; cyDiv.style.pointerEvents = 'auto';
                globeDiv.style.opacity = 0; globeDiv.style.pointerEvents = 'none';
                platforms.forEach(p => p.style.opacity = 0);
                
                cy.elements().removeClass('iso-block');
                
                // *** DAGRE LAYOUT (แก้ปัญหา Network ไม่สวย) ***
                cy.layout({
                    name: 'dagre', // ใช้ dagre เพื่อจัด Hierarchy ซ้าย->ขวา สวยๆ
                    rankDir: 'LR',
                    padding: 50,
                    spacingFactor: 1.2,
                    animate: true, animationDuration: 800
                }).run();
            }
        }

        // --- 3. GLOBE ENGINE (Fixed Labels) ---
        function initGlobe() {
            if(globe) return; // Create once

            const gNodes = appData.nodes.map(n => ({
                id: n.data.id,
                name: n.data.label,
                type: n.data.type,
                color: Colors[n.data.type] || '#fff',
                lat: (Math.random() * 160) - 80,
                lng: (Math.random() * 360) - 180
            }));
            
            const gEdges = appData.edges.map(e => {
                const src = gNodes.find(n => n.id === e.data.source);
                const tgt = gNodes.find(n => n.id === e.data.target);
                return (src && tgt) ? { startLat: src.lat, startLng: src.lng, endLat: tgt.lat, endLng: tgt.lng, color: ['#00f3ff', '#bc13fe'] } : null;
            }).filter(x => x);

            globe = Globe()
                (document.getElementById('globe-container'))
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                .pointsData(gNodes)
                .pointColor('color')
                .pointAltitude(0.1)
                .pointRadius(0.5)
                // *** เพิ่ม LABELS ***
                .labelsData(gNodes)
                .labelLat(d => d.lat)
                .labelLng(d => d.lng)
                .labelText(d => d.name)
                .labelSize(1.5)
                .labelDotRadius(0.5)
                .labelColor(() => 'rgba(255, 255, 255, 0.75)')
                .labelResolution(2)
                // *** ARCS ***
                .arcsData(gEdges)
                .arcColor('color')
                .arcDashLength(0.4)
                .arcDashGap(2)
                .arcDashAnimateTime(1500)
                .onPointClick(node => openSidebar({ label: node.name, type: node.type, details: `Loc: ${node.lat.toFixed(2)}, ${node.lng.toFixed(2)}` }));
        }

        // --- 4. DATA LOGIC ---
        function loadDemo() {
            // Generate Organized Data
            const nodes = []; const edges = [];
            // Suppliers
            for(let i=1;i<=6;i++) nodes.push({group:'nodes', data:{id:`s${i}`, label:`Supplier ${i}`, type:'supplier', details:"Reliability: High"}});
            // Factories
            for(let i=1;i<=4;i++) nodes.push({group:'nodes', data:{id:`f${i}`, label:`Factory ${i}`, type:'factory', details:"Output: 85%"}});
            // Customers
            for(let i=1;i<=8;i++) nodes.push({group:'nodes', data:{id:`c${i}`, label:`Store ${i}`, type:'customer', details:"Sales: $50k"}});

            // Logic: Supplier -> Factory -> Customer
            nodes.forEach(n => {
                if(n.data.type === 'supplier') edges.push({group:'edges', data:{source:n.data.id, target:`f${Math.ceil(Math.random()*4)}`}});
                if(n.data.type === 'factory') edges.push({group:'edges', data:{source:n.data.id, target:`c${Math.ceil(Math.random()*8)}`}});
            });

            appData = { nodes, edges };
            updateGraph();
            setMode('network'); // Default start
        }

        function updateGraph() {
            cy.elements().remove();
            cy.add([...appData.nodes, ...appData.edges]);
        }

        // Upload Logic
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const ns = XLSX.utils.sheet_to_json(workbook.Sheets['Nodes']||workbook.Sheets[workbook.SheetNames[0]]);
                const es = XLSX.utils.sheet_to_json(workbook.Sheets['Edges']||workbook.Sheets[workbook.SheetNames[1]]);
                
                appData.nodes = ns.map(n => ({group:'nodes', data:{id:n.id.toString(), label:n.label, type:(n.type||'default').toLowerCase(), details:n.details}}));
                appData.edges = es.map(e => ({group:'edges', data:{source:e.source.toString(), target:e.target.toString()}}));
                
                updateGraph();
                
                // Reset Globe to reload data
                if(globe) { document.getElementById('globe-container').innerHTML = ''; globe=null; }
                
                // Refresh Current View
                const activeBtn = document.querySelector('.btn.active');
                if(activeBtn && activeBtn.getAttribute('onclick').includes('iso')) setMode('iso');
                else if(activeBtn && activeBtn.getAttribute('onclick').includes('globe')) setMode('globe');
                else setMode('network');
            };
            reader.readAsArrayBuffer(file);
        });

        function openSidebar(data) {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sb-title').innerText = data.label;
            document.getElementById('sb-type').innerText = (data.type||'Object').toUpperCase();
            document.getElementById('sb-type').style.color = Colors[data.type] || '#fff';
            document.getElementById('sb-content').innerText = data.details || "No details available.";
        }
        
        // Init
        window.onload = () => { initCy(); loadDemo(); };

    </script>
</body>
</html>
