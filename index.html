<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOUNDRY X // MULTI-VIEW INTELLIGENCE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- THEME & UI --- */
        :root {
            --bg: #020204;
            --panel: rgba(15, 23, 42, 0.90);
            --border: #334155;
            --accent: #0ea5e9; /* Sky Blue */
            --highlight: #facc15; /* Yellow Warning */
            --danger: #ef4444;
            --success: #10b981;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
        }

        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text-main); }
        
        /* 1. VIEWPORT AREA */
        #cy {
            width: 100vw; height: 100vh;
            background-image: 
                radial-gradient(rgba(30, 41, 59, 0.5) 1px, transparent 1px);
            background-size: 30px 30px;
            z-index: 1; transition: background 0.5s;
        }

        /* Background Map Image (For Geo View) - ซ่อนไว้ก่อน */
        #geo-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg') no-repeat center;
            background-size: contain; opacity: 0; pointer-events: none; z-index: 0; filter: invert(1) opacity(0.1);
            transition: opacity 0.5s;
        }

        /* 2. TOP HUD (Head-Up Display) */
        .hud-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: space-between; align-items: center; padding: 0 30px;
            z-index: 50; pointer-events: none;
        }
        .brand { font-size: 18px; font-weight: 800; letter-spacing: 2px; color: #fff; text-shadow: 0 0 10px var(--accent); }
        .brand i { color: var(--accent); margin-right: 10px; }

        /* View Switcher Tabs */
        .view-controls { pointer-events: auto; display: flex; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 8px; border: 1px solid var(--border); }
        .view-btn {
            background: transparent; border: none; color: var(--text-dim); padding: 8px 15px;
            cursor: pointer; font-size: 12px; font-weight: bold; text-transform: uppercase;
            transition: 0.3s; border-radius: 4px; display: flex; align-items: center; gap: 8px;
        }
        .view-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .view-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }

        /* 3. SIDEBAR DASHBOARD (Glassmorphism) */
        #sidebar {
            position: absolute; top: 70px; right: 20px; bottom: 20px; width: 350px;
            background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
            backdrop-filter: blur(12px); box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            transform: translateX(400px); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 100; display: flex; flex-direction: column; overflow: hidden;
        }
        #sidebar.active { transform: translateX(0); }

        .sb-header { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .sb-title { font-size: 20px; font-weight: 700; color: #fff; margin: 0; }
        .sb-subtitle { font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        
        .sb-content { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* Widgets */
        .kpi-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .kpi-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .kpi-val { font-size: 24px; font-weight: bold; color: #fff; display: block; }
        .kpi-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }

        .alert-box { 
            background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); 
            padding: 15px; margin-bottom: 20px; font-size: 12px; line-height: 1.5; color: #fca5a5;
        }

        /* 4. FOOTER STATS */
        .footer-stats {
            position: absolute; bottom: 20px; left: 20px; 
            font-family: 'Courier New', monospace; font-size: 11px; color: var(--text-dim);
            z-index: 10;
        }
        .live-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; animation: pulse 1s infinite; margin-right: 5px; }
        @keyframes pulse { 0% { opacity: 0.5; } 100% { opacity: 1; box-shadow: 0 0 10px var(--success); } }

    </style>
</head>
<body>

    <div id="geo-bg"></div>

    <div class="hud-top">
        <div class="brand"><i class="fas fa-network-wired"></i> FOUNDRY<span>X</span></div>
        
        <div class="view-controls">
            <button class="view-btn active" onclick="switchView('network')"><i class="fas fa-project-diagram"></i> Network</button>
            <button class="view-btn" onclick="switchView('geo')"><i class="fas fa-globe-americas"></i> Geo Map</button>
            <button class="view-btn" onclick="switchView('layers')"><i class="fas fa-layer-group"></i> Layers</button>
        </div>

        <button onclick="resetData()" class="view-btn" style="border:1px solid #333"><i class="fas fa-sync"></i> Refresh Data</button>
    </div>

    <div id="cy"></div>

    <div id="sidebar">
        <div class="sb-header">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <h2 class="sb-title" id="node-name">Select Node</h2>
                    <div class="sb-subtitle" id="node-type">WAITING FOR INPUT...</div>
                </div>
                <button onclick="closeSidebar()" style="background:none; border:none; color:#666; cursor:pointer; font-size:20px;">&times;</button>
            </div>
        </div>
        <div class="sb-content">
            <div class="alert-box" id="node-alert" style="display:none;">
                <i class="fas fa-exclamation-triangle"></i> <b>WARNING:</b> Supply chain disruption detected. Estimated delay: 4 Days.
            </div>

            <div class="kpi-row">
                <div class="kpi-card">
                    <span class="kpi-val" id="val-1">-</span>
                    <span class="kpi-label">Efficiency</span>
                </div>
                <div class="kpi-card">
                    <span class="kpi-val" id="val-2" style="color:var(--accent)">-</span>
                    <span class="kpi-label">Volume</span>
                </div>
            </div>

            <div style="height: 180px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 20px;">
                <canvas id="miniChart"></canvas>
            </div>

            <div style="font-size:12px; color:#fff; font-weight:bold; margin-bottom:10px;">CONNECTED ENTITIES</div>
            <div id="conn-list" style="font-size:11px; color:var(--text-dim); line-height:1.8;"></div>

        </div>
    </div>

    <div class="footer-stats">
        <span class="live-dot"></span> LIVE DATA FEED // <span id="node-count">0</span> NODES TRACKED // MODE: <span id="current-mode">NETWORK</span>
    </div>

    <script>
        // --- 1. CONFIG & ICONS ---
        // ใช้ FontAwesome บน Node เพื่อความสวยงาม
        const nodeIcons = {
            'supplier': '\uf48b', // Truck (FontAwesome Unicode)
            'factory':  '\uf275', // Industry
            'warehouse':'\uf494', // Box Open
            'store':    '\uf290', // Shopping Bag
            'material': '\uf1b2', // Cube
        };

        const nodeColors = {
            'supplier': '#ef4444', // Red
            'factory':  '#f59e0b', // Orange
            'warehouse':'#0ea5e9', // Blue
            'store':    '#10b981', // Green
            'material': '#8b5cf6', // Purple
        };

        let cy = cytoscape({
            container: document.getElementById('cy'),
            style: [
                {
                    selector: 'node',
                    style: {
                        'label': 'data(label)',
                        'font-family': '"Font Awesome 6 Free", "Segoe UI"', // support icons
                        'font-size': '10px',
                        'color': '#cbd5e1',
                        'text-valign': 'bottom',
                        'text-margin-y': 6,
                        'background-color': '#1e293b',
                        'border-width': 2,
                        'border-color': (ele) => nodeColors[ele.data('type')] || '#64748b',
                        'width': 45, 'height': 45,
                        // ใส่ Icon ตรงกลาง Node
                        'content': (ele) => nodeIcons[ele.data('type')] || '\uf1b2', 
                        'text-halign': 'center', 'text-valign': 'center',
                        'font-weight': 900, // For FontAwesome Solid
                        'color': (ele) => nodeColors[ele.data('type')] || '#fff',
                        'text-outline-width': 0,
                    }
                },
                {
                    selector: 'node[label]', // Label text style below icon
                    style: {
                        'text-valign': 'bottom',
                        'text-margin-y': 8,
                        'font-size': '11px',
                        'color': '#94a3b8',
                        'font-family': 'sans-serif',
                        'font-weight': 'normal',
                        'text-background-color': '#000',
                        'text-background-opacity': 0.7,
                        'text-background-padding': '3px',
                        'text-background-shape': 'roundrectangle'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 1,
                        'line-color': '#334155',
                        'target-arrow-color': '#334155',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'opacity': 0.4
                    }
                },
                // --- FOCUS MODE STYLES ---
                {
                    selector: '.dimmed',
                    style: { 'opacity': 0.1, 'transition-duration': '0.3s' } // หรี่แสง
                },
                {
                    selector: '.highlighted',
                    style: {
                        'border-width': 4,
                        'border-color': '#fff',
                        'shadow-blur': 30,
                        'shadow-color': (ele) => nodeColors[ele.data('type')],
                        'z-index': 999,
                        'opacity': 1
                    }
                },
                {
                    selector: 'edge.highlighted',
                    style: {
                        'line-color': '#fff',
                        'target-arrow-color': '#fff',
                        'width': 3,
                        'z-index': 99,
                        'opacity': 1
                    }
                }
            ],
            layout: { name: 'grid' }
        });

        // --- 2. DATA GENERATOR (ให้ดูเยอะๆ) ---
        function generateBigData() {
            cy.elements().remove();
            let elements = [];
            
            // 1. Create Layers of Supply Chain
            // Suppliers (Global)
            for(let i=1; i<=8; i++) {
                elements.push({ group:'nodes', data: { id: `sup${i}`, label: `Supplier ${i}`, type: 'supplier', country: i%2==0?'USA':'CN' } });
            }
            // Factories (Regional)
            for(let i=1; i<=4; i++) {
                elements.push({ group:'nodes', data: { id: `fac${i}`, label: `Factory ${i}`, type: 'factory', country: 'TH' } });
            }
            // Warehouses (Local)
            for(let i=1; i<=3; i++) {
                elements.push({ group:'nodes', data: { id: `wh${i}`, label: `Dist. Center ${i}`, type: 'warehouse', country: 'TH' } });
            }
            // Stores (Retail)
            for(let i=1; i<=10; i++) {
                elements.push({ group:'nodes', data: { id: `st${i}`, label: `Shop Branch ${i}`, type: 'store', country: 'TH' } });
            }

            // 2. Create Connections
            // Supplier -> Factory
            elements.forEach(n => {
                if(n.data.type === 'supplier') {
                    // Randomly connect to 1-2 factories
                    let target = `fac${Math.ceil(Math.random()*4)}`;
                    elements.push({ group:'edges', data: { source: n.data.id, target: target } });
                }
            });
            // Factory -> Warehouse
            for(let i=1; i<=4; i++) {
                let target = `wh${Math.ceil(Math.random()*3)}`;
                elements.push({ group:'edges', data: { source: `fac${i}`, target: target } });
            }
            // Warehouse -> Store
            for(let i=1; i<=10; i++) {
                let source = `wh${Math.ceil(Math.random()*3)}`;
                elements.push({ group:'edges', data: { source: source, target: `st${i}` } });
            }

            cy.add(elements);
            document.getElementById('node-count').innerText = elements.length;
            switchView('network'); // Default View
        }

        // --- 3. VIEW MODES (หัวใจสำคัญ) ---
        
        function switchView(mode) {
            // Update UI Buttons
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget ? event.currentTarget.classList.add('active') : null;
            document.getElementById('current-mode').innerText = mode.toUpperCase();

            // Reset Styles
            document.getElementById('geo-bg').style.opacity = (mode === 'geo') ? 0.3 : 0;
            cy.style().selector('node').style({'opacity': 1}); // Reset Dim

            if(mode === 'network') {
                // Force Directed Layout (Natural)
                cy.layout({
                    name: 'cose',
                    animate: true,
                    randomize: false,
                    componentSpacing: 100,
                    nodeRepulsion: 400000,
                    edgeElasticity: 100,
                    gravity: 80
                }).run();
            } 
            else if (mode === 'geo') {
                // Geographic Simulation (Fake Map Positions)
                // สมมติ: ซ้าย=USA, ขวา=China, กลาง=Thailand (Hub)
                cy.layout({
                    name: 'preset',
                    animate: true,
                    positions: (node) => {
                        const type = node.data('type');
                        const id = parseInt(node.id().replace(/\D/g,'')) || 0;
                        
                        // Fake Coordinates Logic
                        if(type === 'supplier') {
                            // Split between West (USA) and East (Asia)
                            return id % 2 == 0 
                                ? { x: 100 + (Math.random()*200), y: 200 + (Math.random()*300) } // USA Zone
                                : { x: 800 + (Math.random()*200), y: 200 + (Math.random()*300) }; // China Zone
                        }
                        if(type === 'factory') {
                            // Thailand Zone (Center)
                            return { x: 500 + (Math.random()*100), y: 400 + (Math.random()*100) };
                        }
                        if(type === 'warehouse') {
                            return { x: 500 + (Math.random()*150), y: 600 + (Math.random()*50) };
                        }
                        // Stores scattered below
                        return { x: 300 + (Math.random()*400), y: 700 + (Math.random()*100) };
                    }
                }).run();
                
                // Zoom out to fit world map feeling
                cy.animate({ fit: { padding: 50 } });
            }
            else if (mode === 'layers') {
                // Hierarchical View (Iso-metric like)
                // Top to Bottom flow
                cy.layout({
                    name: 'breadthfirst',
                    directed: true,
                    spacingFactor: 1.5,
                    padding: 30,
                    animate: true
                }).run();
            }
        }

        // --- 4. INTERACTION & FOCUS MODE ---
        
        let chartInstance = null;

        cy.on('tap', 'node', function(evt){
            const node = evt.target;
            
            // 4.1 Focus Effect (Dim others)
            cy.elements().removeClass('highlighted').addClass('dimmed'); // Dim all
            
            const connected = node.neighborhood().add(node); // Get neighbors
            connected.removeClass('dimmed').addClass('highlighted'); // Highlight neighbors
            
            // 4.2 Open Sidebar
            openSidebar(node.data());
        });

        cy.on('tap', function(e){
            if(e.target === cy){
                // Click Background -> Reset
                cy.elements().removeClass('dimmed highlighted');
                closeSidebar();
            }
        });

        function openSidebar(data) {
            const sb = document.getElementById('sidebar');
            sb.classList.add('active');

            // Set Data
            document.getElementById('node-name').innerText = data.label;
            document.getElementById('node-type').innerText = data.type.toUpperCase() + " NODE";
            
            // Mock Data for KPI
            document.getElementById('val-1').innerText = (Math.random() * 100).toFixed(1) + "%";
            document.getElementById('val-2').innerText = Math.floor(Math.random() * 5000) + " Units";

            // Show Warning if random condition
            const isAlert = Math.random() > 0.7;
            document.getElementById('node-alert').style.display = isAlert ? 'block' : 'none';
            document.getElementById('node-name').style.color = isAlert ? '#ef4444' : '#fff';

            // Connection List
            const neighbors = cy.getElementById(data.id).neighborhood('node');
            let listHtml = '';
            neighbors.forEach(n => {
                listHtml += `<div><i class="fas fa-link"></i> ${n.data('label')}</div>`;
            });
            document.getElementById('conn-list').innerHTML = listHtml || 'No active connections';

            // Chart
            renderChart();
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }

        function renderChart() {
            const ctx = document.getElementById('miniChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                    datasets: [{
                        label: 'Throughput',
                        data: Array.from({length:5}, () => Math.random()*100),
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false } // Minimalist chart
                    }
                }
            });
        }
        
        function resetData() { generateBigData(); }

        // Start
        generateBigData();

    </script>
</body>
</html>
