<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FOUNDRY V7 // FINAL STABLE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-dagre/2.5.0/cytoscape-dagre.min.js"></script>

    <style>
        :root { --bg: #050505; --panel: #111; --accent: #00f3ff; --text: #eee; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; height: 100vh; width: 100vw; }

        /* HEADER */
        #toolbar {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: rgba(20,20,20,0.95); border-bottom: 1px solid #333; z-index: 100;
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .btn {
            background: #222; border: 1px solid #444; color: #aaa; padding: 5px 12px;
            cursor: pointer; font-size: 11px; border-radius: 4px; display: inline-flex; align-items: center; gap: 5px;
        }
        .btn:hover, .btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
        input[type="file"] { display: none; }

        /* VIEWPORT - แก้ปัญหา Canvas ล้น/ขาด */
        #viewport {
            position: absolute; top: 50px; left: 0; width: 100vw; height: calc(100vh - 50px);
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        #cy { width: 100%; height: 100%; display: block; }
        #globe-viz { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; pointer-events:none; transition: opacity 0.3s; }

        /* SIDEBAR */
        #sidebar {
            position: absolute; right: 20px; top: 70px; width: 280px; 
            background: rgba(15,15,20,0.95); border: 1px solid #333; border-radius: 8px;
            padding: 15px; transform: translateX(320px); transition: 0.3s; z-index: 200;
        }
        #sidebar.active { transform: translateX(0); }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 999; display: flex; justify-content: center; align-items: center; color: var(--accent);
            display: none;
        }
    </style>
</head>
<body>

    <div id="loader"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div>

    <div id="toolbar">
        <div style="font-weight:bold; letter-spacing:1px;"><i class="fas fa-network-wired"></i> FOUNDRY V7</div>
        <div style="display:flex; gap:10px;">
            <button class="btn active" onclick="setMode('network')">Network</button>
            <button class="btn" onclick="setMode('layers')">Layers</button>
            <button class="btn" onclick="setMode('globe')">Globe</button>
        </div>
        <div style="display:flex; gap:10px;">
            <label for="fileInput" class="btn" style="border-color:var(--accent); color:var(--accent);">
                <i class="fas fa-upload"></i> Import Excel
            </label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <button class="btn" onclick="loadDemo()">Demo Data</button>
        </div>
    </div>

    <div id="viewport">
        <div id="cy"></div>
        <div id="globe-viz"></div>
    </div>

    <div id="sidebar">
        <div style="display:flex; justify-content:space-between;">
            <b id="sb-title">DETAILS</b>
            <span style="cursor:pointer;" onclick="document.getElementById('sidebar').classList.remove('active')">&times;</span>
        </div>
        <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
        <div id="sb-content" style="font-size:13px; color:#ccc; line-height:1.5;"></div>
    </div>

    <script>
        // --- CONFIG ---
        const Colors = { supplier: '#ff4d4d', factory: '#4d79ff', customer: '#33ff99', default: '#888' };
        let cy = null;
        let globe = null;
        let appData = { nodes: [], edges: [] };

        // --- 1. SETUP ---
        window.onload = function() {
            initCy();
            // เรียก resize ทุกครั้งที่หน้าจอเปลี่ยน เพื่อแก้กราฟกองมุม
            window.addEventListener('resize', () => { if(cy) { cy.resize(); cy.fit(); } });
        };

        function initCy() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    { selector: 'node', style: { 'label': 'data(label)', 'color': '#fff', 'font-size': 10, 'background-color': '#333', 'border-width': 2, 'border-color': ele => Colors[ele.data('type')] || '#888', 'width': 40, 'height': 40, 'text-valign': 'bottom', 'text-margin-y': 5 } },
                    { selector: 'edge', style: { 'width': 1, 'line-color': '#555', 'target-arrow-color': '#555', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' } },
                    { selector: ':parent', style: { 'background-opacity': 0.05, 'border-width': 1, 'border-style': 'dashed', 'label': 'data(label)', 'text-valign': 'top', 'color': '#aaa' } }
                ],
                layout: { name: 'grid' } // เริ่มต้นด้วย grid โง่ๆ ไปก่อน
            });

            cy.on('tap', 'node', evt => {
                if(!evt.target.isParent()) openSidebar(evt.target.data());
            });
        }

        // --- 2. EXCEL IMPORT LOGIC (FIXED) ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            document.getElementById('loader').style.display = 'flex';
            
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                
                // อ่าน Sheet แรกเสมอ (แก้ปัญหาชื่อ Sheet ไม่ตรง)
                const firstSheetName = workbook.SheetNames[0];
                const rawNodes = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                
                // พยายามหา Sheet ที่ 2 ถ้ามี ให้เป็น Edges
                let rawEdges = [];
                if(workbook.SheetNames.length > 1) {
                    rawEdges = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[1]]);
                }

                // Map Data (แปลง key เป็น lowercase กันเหนียว)
                appData.nodes = rawNodes.map(r => {
                    // หา key ที่น่าจะเป็น id, label, type (ไม่สนตัวพิมพ์เล็กใหญ่)
                    const keys = Object.keys(r);
                    const getId = k => keys.find(key => key.toLowerCase() === k);
                    
                    return {
                        group: 'nodes',
                        data: {
                            id: (r[getId('id')] || Math.random()).toString(),
                            label: r[getId('label')] || 'Unnamed',
                            type: (r[getId('type')] || 'default').toLowerCase(),
                            details: JSON.stringify(r) // เก็บข้อมูลดิบไว้โชว์
                        }
                    };
                });

                appData.edges = rawEdges.map(r => {
                    const keys = Object.keys(r);
                    const getId = k => keys.find(key => key.toLowerCase() === k);
                    return {
                        group: 'edges',
                        data: {
                            source: (r[getId('source')] || '').toString(),
                            target: (r[getId('target')] || '').toString()
                        }
                    };
                });

                if(appData.nodes.length === 0) alert("No nodes found in Excel!");
                else {
                    setMode('network'); // โหลดกราฟทันที
                    setTimeout(() => alert(`Imported: ${appData.nodes.length} nodes`), 100);
                }

            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        });

        // --- 3. MODE SWITCHING ---
        function setMode(mode) {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            event.currentTarget?.classList.add('active'); // ? เช็คเผื่อกดจาก code

            const cyDiv = document.getElementById('cy');
            const globeDiv = document.getElementById('globe-viz');

            // Reset Visibility
            globeDiv.style.opacity = 0; globeDiv.style.pointerEvents = 'none';
            cyDiv.style.opacity = 1; cyDiv.style.pointerEvents = 'auto';

            if(mode === 'globe') {
                cyDiv.style.opacity = 0; cyDiv.style.pointerEvents = 'none';
                globeDiv.style.opacity = 1; globeDiv.style.pointerEvents = 'auto';
                initGlobe();
            } else {
                cy.elements().remove();
                
                if(mode === 'layers') {
                    // LAYERS MODE: ใช้ Compound Nodes จัดกลุ่ม
                    // สร้าง Parents
                    cy.add([
                        { group:'nodes', data:{id:'L3', label:'CUSTOMERS'} },
                        { group:'nodes', data:{id:'L2', label:'FACTORIES'} },
                        { group:'nodes', data:{id:'L1', label:'SUPPLIERS'} }
                    ]);
                    
                    // Assign Parents
                    const layeredNodes = appData.nodes.map(n => {
                        let pid = 'L2';
                        if(n.data.type === 'supplier') pid = 'L1';
                        if(n.data.type === 'customer') pid = 'L3';
                        return { group:'nodes', data:{...n.data, parent: pid} };
                    });
                    
                    cy.add([...layeredNodes, ...appData.edges]);
                    cy.layout({ name: 'dagre', rankDir: 'BT', padding: 50 }).run();
                    
                } else {
                    // NETWORK MODE
                    cy.add([...appData.nodes, ...appData.edges]);
                    cy.layout({ name: 'cose', animate: true }).run();
                }
                
                // *** FIX: กราฟกองมุม ***
                setTimeout(() => {
                    cy.resize();
                    cy.fit();
                    cy.center();
                }, 100); // รอ Layout รันเสร็จนิดนึงแล้วบังคับ Fit จอ
            }
        }

        // --- 4. GLOBE ---
        function initGlobe() {
            if(globe) return;
            const gData = appData.nodes.map(n => ({
                lat: (Math.random()*160)-80, lng: (Math.random()*360)-180,
                color: Colors[n.data.type] || 'white',
                name: n.data.label
            }));
            
            globe = Globe()
            (document.getElementById('globe-viz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .pointsData(gData)
            .pointAltitude(0.1)
            .pointColor('color')
            .labelsData(gData) // ใส่ชื่อ
            .labelLat(d=>d.lat)
            .labelLng(d=>d.lng)
            .labelText(d=>d.name)
            .labelSize(1.5)
            .labelDotRadius(0.5);
        }

        // --- 5. DEMO DATA ---
        function loadDemo() {
            appData.nodes = [
                {group:'nodes', data:{id:'s1', label:'Supplier A', type:'supplier'}},
                {group:'nodes', data:{id:'s2', label:'Supplier B', type:'supplier'}},
                {group:'nodes', data:{id:'f1', label:'Main Factory', type:'factory'}},
                {group:'nodes', data:{id:'c1', label:'Store 1', type:'customer'}},
                {group:'nodes', data:{id:'c2', label:'Store 2', type:'customer'}}
            ];
            appData.edges = [
                {group:'edges', data:{source:'s1', target:'f1'}},
                {group:'edges', data:{source:'s2', target:'f1'}},
                {group:'edges', data:{source:'f1', target:'c1'}},
                {group:'edges', data:{source:'f1', target:'c2'}}
            ];
            setMode('network');
        }

        function openSidebar(data) {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sb-content').innerText = JSON.stringify(data, null, 2);
        }

    </script>
</body>
</html>
