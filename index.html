<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FOUNDRY X // ISO-LAYER ENGINE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #050505;
            --panel: rgba(20, 20, 25, 0.9);
            --border: #333;
            --accent: #3b82f6;
            --text: #e2e8f0;
        }
        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--text); }

        /* VIEWPORTS */
        #viewport { position: relative; width: 100vw; height: 100vh; }
        #cy-container, #globe-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.5s; }
        #globe-container { opacity: 0; pointer-events: none; z-index: 5; }
        #cy-container { z-index: 10; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }

        /* HUD */
        .hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .controls { display: flex; gap: 10px; }
        .btn {
            background: rgba(255,255,255,0.05); border: 1px solid #444; color: #aaa;
            padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold;
            display: flex; align-items: center; gap: 8px; transition: 0.2s; text-transform: uppercase;
        }
        .btn:hover, .btn.active { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 0 15px rgba(59,130,246,0.4); }
        
        /* SIDEBAR */
        #sidebar {
            position: absolute; top: 70px; right: 20px; bottom: 20px; width: 300px;
            background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
            transform: translateX(350px); transition: transform 0.3s; z-index: 50;
            backdrop-filter: blur(10px); display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }
        .sb-head { padding: 15px; border-bottom: 1px solid var(--border); font-weight: bold; }
        .sb-body { padding: 15px; overflow-y: auto; flex: 1; }
        
        /* TOAST NOTIFICATION */
        #toast {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: #10b981; color: #fff; padding: 10px 20px; border-radius: 20px;
            font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 200;
        }

        /* HIDDEN INPUT */
        #file-input { display: none; }
    </style>
</head>
<body>

    <div id="toast"><i class="fas fa-check"></i> System Updated</div>

    <div class="hud">
        <div style="font-weight:900; letter-spacing:2px; display:flex; gap:10px; align-items:center;">
            <i class="fas fa-cube" style="color:var(--accent)"></i> FOUNDRY X <span style="font-size:10px; color:#666; font-weight:normal;">| ISO-ENGINE v4</span>
        </div>
        
        <div class="controls">
            <button class="btn active" onclick="switchView('network', this)"><i class="fas fa-share-alt"></i> Network</button>
            <button class="btn" onclick="switchView('globe', this)"><i class="fas fa-globe"></i> 3D Globe</button>
            <button class="btn" onclick="switchView('layers', this)"><i class="fas fa-layer-group"></i> Iso-Layers</button>
        </div>

        <div class="controls">
            <label for="file-input" class="btn"><i class="fas fa-upload"></i> Import Excel</label>
            <input type="file" id="file-input" accept=".xlsx, .xls">
            <button class="btn" onclick="loadDemo()"><i class="fas fa-sync"></i> Demo</button>
        </div>
    </div>

    <div id="viewport">
        <div id="cy-container"></div>
        <div id="globe-container"></div>
    </div>

    <div id="sidebar">
        <div class="sb-head">NODE DETAILS</div>
        <div class="sb-body" id="sb-content">Select a node...</div>
    </div>

    <script>
        // --- CONFIG ---
        let cy, globe;
        let appData = { nodes: [], edges: [] };
        const COLORS = { supplier: '#ef4444', factory: '#3b82f6', warehouse: '#f59e0b', store: '#10b981', default: '#94a3b8' };

        // --- 1. INITIALIZE ---
        window.onload = () => {
            initCy();
            loadDemo(); // Load fake data first
        };

        function initCy() {
            cy = cytoscape({
                container: document.getElementById('cy-container'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)', 'color': '#fff', 'font-size': '10px',
                            'background-color': '#1a1a1a', 'border-width': 2,
                            'border-color': ele => COLORS[ele.data('type')] || '#555',
                            'width': 40, 'height': 40, 'text-valign': 'bottom', 'text-margin-y': 5
                        }
                    },
                    {
                        selector: 'edge',
                        style: { 'width': 1, 'line-color': '#444', 'target-arrow-color': '#444', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    // ISOMETRIC STYLE (ทำให้ดูเหมือนแผ่นป้าย)
                    {
                        selector: '.iso-node',
                        style: {
                            'shape': 'round-rectangle', 'width': 80, 'height': 50,
                            'font-size': '8px', 'text-valign': 'center', 'text-halign': 'center',
                            'background-opacity': 0.8, 'shadow-blur': 10, 'shadow-offset-y': 10, 'shadow-color': '#000'
                        }
                    }
                ]
            });

            cy.on('tap', 'node', evt => openSidebar(evt.target.data()));
            cy.on('tap', evt => { if(evt.target === cy) document.getElementById('sidebar').classList.remove('active'); });
        }

        // --- 2. ISOMETRIC LAYOUT ENGINE (สูตรลับ Fake 3D) ---
        function runIsometricLayout() {
            cy.elements().addClass('iso-node'); // เปลี่ยน Style เป็นแผ่นป้าย

            // แยก Node ตามประเภท (เพื่อวางคนละชั้น)
            const layers = {
                'supplier': { nodes: [], yBase: 600 },  // ชั้นล่าง
                'factory':  { nodes: [], yBase: 300 },  // ชั้นกลาง
                'default':  { nodes: [], yBase: 0 }     // ชั้นบน (Store/Warehouse)
            };

            // จัดกลุ่ม Nodes
            cy.nodes().forEach(node => {
                let type = node.data('type');
                if (!layers[type]) type = 'default';
                layers[type].nodes.push(node);
            });

            // คำนวณตำแหน่ง Isometric (x = isoX, y = isoY)
            // สูตร: ScreenX = (gridX - gridY) * width
            // สูตร: ScreenY = (gridX + gridY) * height - layerOffset
            
            cy.batch(() => {
                Object.keys(layers).forEach(key => {
                    const layer = layers[key];
                    const count = layer.nodes.length;
                    const cols = Math.ceil(Math.sqrt(count));
                    
                    layer.nodes.forEach((node, index) => {
                        const row = Math.floor(index / cols);
                        const col = index % cols;
                        
                        // Isometric Transformation
                        const isoX = (col - row) * 80; 
                        const isoY = (col + row) * 40 + layer.yBase;

                        node.position({ x: isoX + 500, y: isoY }); // +500 เพื่อให้อยู่กลางจอ
                    });
                });
            });

            cy.fit();
        }

        // --- 3. VIEW SWITCHER ---
        function switchView(mode, btn) {
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const cyDiv = document.getElementById('cy-container');
            const globeDiv = document.getElementById('globe-container');

            if (mode === 'globe') {
                cyDiv.style.opacity = 0; cyDiv.style.pointerEvents = 'none';
                globeDiv.style.opacity = 1; globeDiv.style.pointerEvents = 'auto';
                initGlobe(); // Create Globe if not exists
            } else {
                cyDiv.style.opacity = 1; cyDiv.style.pointerEvents = 'auto';
                globeDiv.style.opacity = 0; globeDiv.style.pointerEvents = 'none';

                cy.elements().removeClass('iso-node');
                
                if (mode === 'layers') {
                    runIsometricLayout(); // เรียกใช้สูตร Iso ใหม่
                } else {
                    // Normal Network
                    cy.layout({ name: 'cose', animate: true }).run();
                }
            }
        }

        // --- 4. UPLOAD LOGIC (FIXED!) ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // อ่านข้อมูล (รองรับทั้ง Sheet 'Nodes' หรือ Sheet แรก)
                const nodeSheet = workbook.Sheets['Nodes'] || workbook.Sheets[workbook.SheetNames[0]];
                const edgeSheet = workbook.Sheets['Edges'] || workbook.Sheets[workbook.SheetNames[1]];
                
                const rawNodes = XLSX.utils.sheet_to_json(nodeSheet);
                const rawEdges = edgeSheet ? XLSX.utils.sheet_to_json(edgeSheet) : [];

                // แปลงข้อมูล
                const nodes = rawNodes.map(n => ({
                    group: 'nodes',
                    data: { id: n.id.toString(), label: n.label, type: (n.type||'default').toLowerCase(), details: n.details }
                }));
                const edges = rawEdges.map(e => ({
                    group: 'edges',
                    data: { source: e.source.toString(), target: e.target.toString() }
                }));

                // อัพเดทระบบ
                appData = { nodes, edges };
                updateSystem();
                showToast("File Loaded Successfully!");
            };
            reader.readAsArrayBuffer(file);
        });

        function updateSystem() {
            cy.elements().remove();
            cy.add([...appData.nodes, ...appData.edges]);
            
            // ถ้าอยู่ในโหมดไหน ให้จัด Layout โหมดนั้นใหม่
            if (document.querySelector('.btn.active').innerText.includes('Layers')) {
                runIsometricLayout();
            } else if (document.querySelector('.btn.active').innerText.includes('Network')) {
                cy.layout({ name: 'cose', animate: true }).run();
            } else {
                // Globe mode: reset globe logic
                document.getElementById('globe-container').innerHTML = ''; // Clear old globe
                globe = null;
                initGlobe();
            }
        }

        // --- 5. GLOBE LOGIC ---
        function initGlobe() {
            if (globe) return;
            
            const gNodes = appData.nodes.map(n => ({
                id: n.data.id,
                name: n.data.label,
                type: n.data.type,
                color: COLORS[n.data.type] || '#fff',
                lat: (Math.random() * 160) - 80,
                lng: (Math.random() * 360) - 180,
                val: 1
            }));
            
            const gEdges = appData.edges.map(e => {
                const src = gNodes.find(n => n.id == e.data.source);
                const tgt = gNodes.find(n => n.id == e.data.target);
                return src && tgt ? { startLat: src.lat, startLng: src.lng, endLat: tgt.lat, endLng: tgt.lng, color: [src.color, tgt.color] } : null;
            }).filter(x => x);

            globe = Globe()
                (document.getElementById('globe-container'))
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
                .pointsData(gNodes)
                .pointColor('color')
                .pointAltitude(0.1)
                .pointRadius(0.5)
                .arcsData(gEdges)
                .arcColor('color')
                .arcDashLength(0.5)
                .arcDashGap(2)
                .arcDashAnimateTime(2000)
                .onPointClick(node => openSidebar({ label: node.name, type: node.type, details: `Lat: ${node.lat.toFixed(2)}` }));
        }

        // --- 6. UTILS ---
        function loadDemo() {
            const nodes = [];
            const edges = [];
            // Generate Suppliers
            for(let i=1;i<=6;i++) nodes.push({group:'nodes', data:{id:`s${i}`, label:`Supplier ${i}`, type:'supplier'}});
            // Generate Factories
            for(let i=1;i<=3;i++) nodes.push({group:'nodes', data:{id:`f${i}`, label:`Factory ${i}`, type:'factory'}});
            // Generate Stores
            for(let i=1;i<=12;i++) nodes.push({group:'nodes', data:{id:`st${i}`, label:`Store ${i}`, type:'store'}});

            // Connect
            nodes.forEach(n => {
                if(n.data.type==='supplier') edges.push({group:'edges', data:{source:n.data.id, target:`f${Math.ceil(Math.random()*3)}`}});
                if(n.data.type==='factory') edges.push({group:'edges', data:{source:n.data.id, target:`st${Math.ceil(Math.random()*12)}`}});
            });

            appData = { nodes, edges };
            updateSystem();
        }

        function openSidebar(data) {
            const sb = document.getElementById('sidebar');
            sb.classList.add('active');
            const color = COLORS[data.type] || '#fff';
            document.getElementById('sb-content').innerHTML = `
                <h2 style="color:${color}; margin-top:0;">${data.label}</h2>
                <div style="font-size:11px; color:#aaa; margin-bottom:10px;">TYPE: ${(data.type||'').toUpperCase()}</div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:4px; font-size:12px;">
                    ${data.details || 'System Active. No alerts.'}
                </div>
            `;
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }
    </script>
</body>
</html>
