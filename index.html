<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Ontology System (Excel Integration)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS STYLE: Dark Tech Theme --- */
        body {
            background-color: #050505;
            color: #e0e0e0;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        #cy {
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(30, 30, 30, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(30, 30, 30, 0.5) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
        }

        /* à¸›à¸¸à¹ˆà¸¡ Upload Excel */
        .upload-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border: 1px solid #333;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .upload-btn {
            background: linear-gradient(45deg, #2563eb, #1d4ed8);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.6);
        }

        #file-input { display: none; }

        /* Detail Panel */
        #info-panel {
            position: absolute;
            top: 100px;
            left: 20px;
            width: 300px;
            background: rgba(15, 15, 20, 0.95);
            border: 1px solid #333;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
            display: none;
            z-index: 20;
        }

        h3 {
            margin: 0 0 15px 0;
            color: #fff;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            font-size: 16px;
            letter-spacing: 1px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .label { color: #888; }
        .value { color: #fff; font-weight: 600; text-align: right;}
    </style>
</head>
<body>

    <div class="upload-container">
        <span style="color: #aaa; font-size: 12px;">DATA SOURCE:</span>
        <label for="file-input" class="upload-btn">ðŸ“‚ Import Excel</label>
        <input type="file" id="file-input" accept=".xlsx, .xls" />
    </div>

    <div id="cy"></div>

    <div id="info-panel">
        <h3 id="panel-title">OBJECT DETAILS</h3>
        <div id="panel-content">Select an object to view details</div>
    </div>

    <script>
        // 1. Initialize Cytoscape Instance
        var cy = cytoscape({
            container: document.getElementById('cy'),
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#1f2937',
                        'label': 'data(label)',
                        'color': '#fff',
                        'font-size': '12px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'width': '140px',
                        'height': '50px',
                        'shape': 'round-rectangle',
                        'border-width': 2,
                        'border-color': '#3b82f6',
                        'text-transform': 'uppercase'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#4b5563',
                        'target-arrow-color': '#4b5563',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(label)',
                        'color': '#6b7280',
                        'font-size': '10px',
                        'text-background-opacity': 1,
                        'text-background-color': '#050505',
                        'text-background-padding': '3px'
                    }
                },
                // Highlight Style
                {
                    selector: '.highlighted',
                    style: {
                        'background-color': '#1e3a8a',
                        'line-color': '#3b82f6',
                        'target-arrow-color': '#3b82f6',
                        'border-color': '#60a5fa',
                        'border-width': 3,
                        'shadow-blur': 20,
                        'shadow-color': '#3b82f6'
                    }
                },
                {
                    selector: '.faded',
                    style: { 'opacity': 0.1 }
                }
            ],
            layout: { name: 'grid' } // Default layout before data loads
        });

        // 2. Handle File Upload & Parsing
        document.getElementById('file-input').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, {type: 'array'});

                // à¸­à¹ˆà¸²à¸™ Sheet "Nodes"
                var nodesSheet = workbook.Sheets['Nodes'];
                var nodesData = XLSX.utils.sheet_to_json(nodesSheet);

                // à¸­à¹ˆà¸²à¸™ Sheet "Edges"
                var edgesSheet = workbook.Sheets['Edges'];
                var edgesData = XLSX.utils.sheet_to_json(edgesSheet);

                // à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸›à¹‡à¸™ Format à¸‚à¸­à¸‡ Cytoscape
                var cyElements = [];

                nodesData.forEach(node => {
                    cyElements.push({
                        group: 'nodes',
                        data: { 
                            id: node.id.toString(), 
                            label: node.label, 
                            type: node.type,
                            details: node.details // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸´à¸šà¹„à¸§à¹‰à¹‚à¸Šà¸§à¹Œ
                        }
                    });
                });

                edgesData.forEach(edge => {
                    cyElements.push({
                        group: 'edges',
                        data: { 
                            source: edge.source.toString(), 
                            target: edge.target.toString(), 
                            label: edge.label 
                        }
                    });
                });

                // à¸£à¸µà¹€à¸‹à¹‡à¸•à¹à¸¥à¸°à¹‚à¸«à¸¥à¸”à¸à¸£à¸²à¸Ÿà¹ƒà¸«à¸¡à¹ˆ
                cy.elements().remove();
                cy.add(cyElements);
                
                // à¸ˆà¸±à¸” Layout à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸«à¹‰à¸ªà¸§à¸¢à¸‡à¸²à¸¡
                cy.layout({
                    name: 'breadthfirst',
                    directed: true,
                    padding: 50,
                    spacingFactor: 1.5,
                    animate: true
                }).run();
            };
            reader.readAsArrayBuffer(file);
        });

        // 3. Interaction Logic (Click & Highlight)
        cy.on('tap', 'node', function(evt){
            var node = evt.target;
            
            // Highlight Logic
            cy.elements().removeClass('faded highlighted');
            var neighborhood = node.neighborhood().add(node);
            cy.elements().not(neighborhood).addClass('faded');
            neighborhood.addClass('highlighted');

            // Update Info Panel
            var detailsRaw = node.data('details') || "No details available";
            // à¹à¸›à¸¥à¸‡ string "Key: Value | Key2: Value2" à¹€à¸›à¹‡à¸™ HTML (à¸–à¹‰à¸²à¸¡à¸µ)
            var detailsHtml = "";
            
            if(detailsRaw.includes('|')) {
                var parts = detailsRaw.split('|');
                parts.forEach(part => {
                    var [key, val] = part.split(':');
                    if(key && val) {
                        detailsHtml += `<div class="data-row"><span class="label">${key.trim()}</span><span class="value">${val.trim()}</span></div>`;
                    }
                });
            } else {
                detailsHtml = `<div class="data-row"><span class="value">${detailsRaw}</span></div>`;
            }

            document.getElementById('panel-title').innerText = node.data('label');
            document.getElementById('panel-content').innerHTML = detailsHtml;
            document.getElementById('info-panel').style.display = 'block';
        });

        // Click Background to Reset
        cy.on('tap', function(evt){
            if(evt.target === cy){
                cy.elements().removeClass('faded highlighted');
                document.getElementById('info-panel').style.display = 'none';
            }
        });

    </script>
</body>
</html>
